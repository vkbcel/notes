<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第03讲：高性能数据库表该如何设计 | 笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.6d79335f.css" as="style"><link rel="preload" href="/assets/js/app.bb7afb86.js" as="script"><link rel="preload" href="/assets/js/2.762c3895.js" as="script"><link rel="preload" href="/assets/js/3.116fffb6.js" as="script"><link rel="preload" href="/assets/js/29.474ecc3a.js" as="script"><link rel="prefetch" href="/assets/js/10.dfdfed3b.js"><link rel="prefetch" href="/assets/js/11.d408ae27.js"><link rel="prefetch" href="/assets/js/12.c9a2a110.js"><link rel="prefetch" href="/assets/js/13.29537945.js"><link rel="prefetch" href="/assets/js/14.58508e1d.js"><link rel="prefetch" href="/assets/js/15.41f020b6.js"><link rel="prefetch" href="/assets/js/16.967be611.js"><link rel="prefetch" href="/assets/js/17.3a77f95b.js"><link rel="prefetch" href="/assets/js/18.7a36127b.js"><link rel="prefetch" href="/assets/js/19.0b62e6ce.js"><link rel="prefetch" href="/assets/js/20.014deb12.js"><link rel="prefetch" href="/assets/js/21.9bc74793.js"><link rel="prefetch" href="/assets/js/22.473a03de.js"><link rel="prefetch" href="/assets/js/23.6e1fa5ea.js"><link rel="prefetch" href="/assets/js/24.03571259.js"><link rel="prefetch" href="/assets/js/25.96341511.js"><link rel="prefetch" href="/assets/js/26.b85641dd.js"><link rel="prefetch" href="/assets/js/27.392150b4.js"><link rel="prefetch" href="/assets/js/28.552817b0.js"><link rel="prefetch" href="/assets/js/30.6856567f.js"><link rel="prefetch" href="/assets/js/31.b6affd07.js"><link rel="prefetch" href="/assets/js/32.cc75c9b5.js"><link rel="prefetch" href="/assets/js/33.fe2bc6ef.js"><link rel="prefetch" href="/assets/js/34.df97f675.js"><link rel="prefetch" href="/assets/js/35.8669e525.js"><link rel="prefetch" href="/assets/js/36.6071604f.js"><link rel="prefetch" href="/assets/js/37.06e1b1cc.js"><link rel="prefetch" href="/assets/js/38.f968eb63.js"><link rel="prefetch" href="/assets/js/39.895e952b.js"><link rel="prefetch" href="/assets/js/4.8fba8a13.js"><link rel="prefetch" href="/assets/js/40.8f97c217.js"><link rel="prefetch" href="/assets/js/41.151335ec.js"><link rel="prefetch" href="/assets/js/42.1e060412.js"><link rel="prefetch" href="/assets/js/43.f5974a0f.js"><link rel="prefetch" href="/assets/js/44.d883de6e.js"><link rel="prefetch" href="/assets/js/45.26a6d799.js"><link rel="prefetch" href="/assets/js/46.8cde2342.js"><link rel="prefetch" href="/assets/js/47.55a26fdc.js"><link rel="prefetch" href="/assets/js/48.463ab798.js"><link rel="prefetch" href="/assets/js/49.12aa900c.js"><link rel="prefetch" href="/assets/js/5.16e339f1.js"><link rel="prefetch" href="/assets/js/50.38d9c43d.js"><link rel="prefetch" href="/assets/js/51.e64f6a9e.js"><link rel="prefetch" href="/assets/js/52.5ed8ce21.js"><link rel="prefetch" href="/assets/js/53.a2525f8c.js"><link rel="prefetch" href="/assets/js/6.ad56fd87.js"><link rel="prefetch" href="/assets/js/7.a0478efc.js"><link rel="prefetch" href="/assets/js/8.57f49743.js"><link rel="prefetch" href="/assets/js/9.1a683027.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d79335f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/unclassified/" class="nav-link">
  未分类
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Golang
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MySQL Menu" class="dropdown-title"><span class="title">MySQL</span> <span class="arrow down"></span></button> <button type="button" aria-label="MySQL Menu" class="mobile-dropdown-title"><span class="title">MySQL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/mysql/lagou/" class="nav-link router-link-active">
  高性能MySQL实战
</a></li></ul></div></div><div class="nav-item"><a href="/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/bigdata/" class="nav-link">
  大数据
</a></div></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/unclassified/" class="nav-link">
  未分类
</a></div><div class="nav-item"><a href="/golang/" class="nav-link">
  Golang
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="MySQL Menu" class="dropdown-title"><span class="title">MySQL</span> <span class="arrow down"></span></button> <button type="button" aria-label="MySQL Menu" class="mobile-dropdown-title"><span class="title">MySQL</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link router-link-active">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/mysql/lagou/" class="nav-link router-link-active">
  高性能MySQL实战
</a></li></ul></div></div><div class="nav-item"><a href="/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/bigdata/" class="nav-link">
  大数据
</a></div></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="使用原则"><a href="#使用原则" class="header-anchor">#</a> 使用原则</h2> <p>MySQL 虽然具有很多特性并提供了很多功能，但是有些特性会严重影响它的性能，比如，在数据库里进行计算，写大事务、大 SQL、存储大字段等。</p> <p>想要发挥 MySQL 的最佳性能，需要遵循 3 个基本使用原则。</p> <ol><li><p>首先是需要让 MySQL 回归存储的基本职能：MySQL 数据库只用于数据的存储，不进行数据的复杂计算，不承载业务逻辑，确保存储和计算分离；</p></li> <li><p>其次是查询数据时，尽量单表查询，减少跨库查询和多表关联；</p></li> <li><p>还有就是要杜绝大事务、大 SQL、大批量、大字段等一系列性能杀手。</p></li></ol> <ul><li><p>大事务，运行步骤较多，涉及的表和字段较多，容易造成资源的争抢，甚至形成死锁。一旦事务回滚，会导致资源占用时间过长。</p></li> <li><p>大 SQL，复杂的 SQL 意味着过多的表的关联，MySQL 数据库处理关联超过 3 张表以上的 SQL 时，占用资源多，性能低下。</p></li> <li><p>大批量，意味着多条 SQL 一次性执行完成，必须确保进行充分的测试，并且在业务低峰时段或者非业务时段执行。</p></li> <li><p>大字段，blob、text 等大字段，尽量少用。必须要用时，尽量与主业务表分离，减少对这类字段的检索和更新。</p></li></ul> <h2 id="基本设置规则"><a href="#基本设置规则" class="header-anchor">#</a> 基本设置规则</h2> <ol><li><p>必须指定默认存储引擎为 InnoDB，并且禁用 MyISAM 存储引擎，随着 MySQL 8.0 版本的发布，所有的数据字典表都已经转换成了 InnoDB，MyISAM 存储引擎已成为了历史。</p></li> <li><p>默认字符集 UTF8mb4，以前版本的 UTF8 是 UTF8mb3，未包含个别特殊字符，新版本的 UTF8mb4 包含所有字符，官方强烈建议使用此字符集。</p></li> <li><p>关闭区分大小写功能。设置 lower_case_tables_name=1，即可关闭区分大小写功能，即大写字母 T 和小写字母 t 一样。</p></li></ol> <p>MySQL 数据库提供的功能很全面，但并不是所有的功能性能都高效。</p> <ol><li><p>存储过程、触发器、视图、event。为了存储计算分离，这类功能尽量在程序中实现。这些功能非常不完整，调试、排错、监控都非常困难，相关数据字典也不完善，存在潜在的风险。一般在生产数据库中，禁止使用。</p></li> <li><p>lob、text、enum、set。这些字段类型，在 MySQL 数据库的检索性能不高，很难使用索引进行优化。如果必须使用这些功能，一般采取特殊的结构设计，或者与程序结合使用其他的字段类型替代。比如：set 可以使用整型（0，1，2，3）、注释功能和程序的检查功能集合替代。</p></li></ol> <h2 id="规范命名"><a href="#规范命名" class="header-anchor">#</a> 规范命名</h2> <p>库名的命名规范如下，命名时的字符取值范围为：a~z，0~9 和 _（下画线）。</p> <ol><li><p>所有表名小写，不允许驼峰式命名；</p></li> <li><p>允许使用 -（横线）和 （空格）；如下图所示，当使用 -（横线），后台默认会转化成 @002d；</p></li> <li><p>不允许使用其他特殊字符作为名称，减少潜在风险。</p></li></ol> <p>数据库库名的命名规则必须遵循“见名知意”的原则，即库名规则为“数据库类型代码 + 项目简称 + 识别代码 + 序号”。</p> <p>这样包含了更多的业务信息，比如：</p> <ul><li><p>出入系统业务生产库：AOCT、AOCT1、AOCT2；</p></li> <li><p>出入系统业务开发库：AOCTDEV、AOCTDEV1、AOCTDEV2；</p></li> <li><p>出入系统业务测试库：AOCTTEST、AOCTTEST1、AOCTTEST2；</p></li> <li><p>只有一个数据库，则不加序号，否则末尾增加序号；</p></li> <li><p>生产库不加识别代码，否则需要增加识别代码 DEV 或 TEST；</p></li> <li><p>如果只作历史库，则只需要项目简称 +H+ 序号；</p></li></ul> <p>表名的命名规则分为：</p> <ol><li><p>单表仅使用 a~z、_；</p></li> <li><p>分表名称为“表名_编号”；</p></li> <li><p>业务表名代表用途、内容：子系统简称_业务含义_后缀。</p></li></ol> <p>常见业务表类型有：</p> <ul><li><p>临时表，tmp；</p></li> <li><p>备份表，bak；</p></li> <li><p>字典表，dic；</p></li> <li><p>日志表，log。</p></li></ul> <p>字段名精确，遵循“见名知意”的原则，格式：名称_后缀。</p> <ul><li>避免普遍简单、有歧义的名称。</li></ul> <p>用户表中，用户名的字段为 UserName 比 Name 更好。</p> <ul><li>布尔型的字段，以助动词（has/is）开头。</li></ul> <p>用户是否有留言 hasmessage，用户是否通过检查 ischecked 等。</p> <p>常见后缀如下：</p> <ul><li><p>流水号/无意义主键，后缀为 id，比如 task_id；</p></li> <li><p>时间，后缀为 time，insert_time。</p></li></ul> <p>程序账号与数据库名称保持一致。如果所有的程序账号都是 root@‘%’，密码也一样，很容易错连到其他的数据库，造成误操作。</p> <p>索引命名格式，主要为了区分哪些对象是索引：</p> <ul><li><p>前缀_表名（或缩写）_字段名（或缩写）；</p></li> <li><p>主键必须使用前缀“pk_”；</p></li> <li><p>UNIQUE 约束必须使用前缀“uk_”；</p></li> <li><p>普通索引必须使用前缀“idx_”。</p></li></ul> <p>数据库规范库表字段的命名，能够提高数据库的易读性，为数据库表设计打下基础。下面我们具体看看表设计的一些规则。</p> <ul><li>显式指定需要的属性；</li></ul> <p>创建表时显示指定字符集、存储引擎、注释信息等。</p> <ul><li>不同系统之间，统一规范；</li></ul> <p>不同表之间的相同字段或者关联字段，字段类型/命名要保持一致；库表字符集和前端程序、中间件必须保持一致的 UTF8mb4。</p> <h3 id="innodb-表的注意事项"><a href="#innodb-表的注意事项" class="header-anchor">#</a> InnoDB 表的注意事项</h3> <ol><li><p>主键列，UNSIGNED 整数，使用 auto_increment；禁止手动更新 auto_increment，可以删除。</p></li> <li><p>必须添加 comment 注释。</p></li> <li><p>必须显示指定的 engine。</p></li> <li><p>表必备三字段：id、 xxx_create、 xxx_modified。</p></li></ol> <ul><li><p>id 为主键，类型为 unsigned bigint 等数字类型；</p></li> <li><p>xxx_create、xxx_modified 的类型均为 datetime 类型，分别记录该条数据的创建时间、修改时间。</p></li></ul> <h3 id="备份表-临时表等常见表的设计规范"><a href="#备份表-临时表等常见表的设计规范" class="header-anchor">#</a> 备份表/临时表等常见表的设计规范</h3> <p>备份表/临时表等常见表的设计规范如下。</p> <ol><li><p>备份表，表名必须添加 bak 和日期，主要用于系统版本上线时，存储原始数据，上线完成后，必须及时删除。</p></li> <li><p>临时表，用于存储中间业务数据，定期优化，及时降低表碎片。</p></li> <li><p>日志类表，首先考虑不入库，保存成文件，其次如果入库，明确其生命周期，保留业务需求的数据，定期清理。</p></li> <li><p>大字段表，把主键字段和大字段，单独拆分成表，并且保持与主表主键同步，尽量减少大字段的检索和更新。</p></li> <li><p>大表，根据业务需求，从垂直和水平两个维度进行拆分。</p></li></ol> <p>垂直拆分：按列关联度。</p> <p>水平拆分：</p> <ul><li><p>按照时间、地域、范围等；</p></li> <li><p>冷热数据（历史数据归档）。</p></li></ul> <p>字段设计要求</p> <ol><li><p>根据业务场景需求，选择合适的类型，最短的长度；确保字段的宽度足够用，但也不要过宽。所有字段必须为 NOT NULL，空值则指定 default 值，空值难以优化，查询效率低。比如：人的年龄用 unsigned tinyint（范围 0~255，人的寿命不会超过 255 岁）；海龟就必须是 smallint，但如果是太阳的年龄，就必须是 int；如果是所有恒星的年龄都加起来，那么就必须使用 bigint。</p></li> <li><p>表字段数少而精，尽量不加冗余列。</p></li> <li><p>单实例表个数必须控制在 2000 个以内。</p></li> <li><p>单表分表个数必须控制在 1024 个以内。</p></li> <li><p>单表字段数上限控制在 20~50 个。</p></li></ol> <p>禁用 ENUM、SET 类型。</p> <ul><li>兼容性不好，性能差。</li></ul> <p>解决方案：使用 TINYINT，在 COMMENT 信息中标明被枚举的含义。<code>is_disable</code> TINYINT UNSIGNED DEFAULT '0' COMMENT '0:启用 1:禁用 2:异常’。</p> <p>禁用列为 NULL。</p> <ul><li><p>MySQL 难以优化 NULL 列；</p></li> <li><p>NULL 列加索引，需要额外空间；</p></li> <li><p>含 NULL 复合索引无效。</p></li></ul> <p>解决方案：在列上添加 NOT NULL DEFAULT 缺省值。</p> <p>禁止 VARBINARY、BLOB 存储图片、文件等。</p> <ul><li>禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统中，数据库中存储路径。</li></ul> <p>不建议使用 TEXT/BLOB：</p> <ul><li><p>处理性能差；</p></li> <li><p>行长度变长；</p></li> <li><p>全表扫描代价大。</p></li></ul> <p>解决方案：拆分成单独的表。</p> <p>存储字节越小，占用空间越小。尽量选择合适的整型，如下图所示。</p> <p><img src="/mysql/03_int.png" alt=""></p> <ol><li><p>主键列，无负数，建议使用 INT UNSIGNED 或者 BIGINT UNSIGNED；预估字段数字取值会超过 42 亿，使用 BIGINT 类型。</p></li> <li><p>短数据使用 TINYINT 或 SMALLINT，比如：人类年龄，城市代码。</p></li> <li><p>使用 UNSIGNED 存储非负数值，扩大正数的范围。</p></li></ol> <p><strong>int(3)/int(5) 区别</strong></p> <p>int(3)/int(5) 的区别，如下图所示。</p> <p><img src="/mysql/03_int3_5.png" alt=""></p> <ul><li><p>正常显示没有区别。</p></li> <li><p>3 和 5 仅是最小显示宽度而已。</p></li> <li><p>有 zerofill 等扩展属性时则显示有区别。</p></li></ul> <p><strong>浮点数与定点数区别</strong></p> <p>浮点数与定点数区别，如下图所示。</p> <p><img src="/mysql/03_float_decimal.png" alt=""></p> <ol><li><p>浮点数：float、double（或 real）。</p></li> <li><p>定点数：decimal（或 numberic）。</p></li></ol> <p>从上图中可以观察到：</p> <ul><li><p>浮点数存在误差问题；</p></li> <li><p>尽量避免进行浮点数比较；</p></li> <li><p>对货币等对精度敏感的数据，应该使用定点数。</p></li></ul> <h2 id="案例"><a href="#案例" class="header-anchor">#</a> 案例</h2> <p><strong>IP 处理</strong></p> <p>一般使用 Char(15) 进行存储，但是当进行查找和统计时，字符类型不是很高效。</p> <p>MySQL 数据库内置了两个 IP 相关的函数 INET_ATON()、INET_NTOA()，可以实现 IP 地址和整数的项目转换。</p> <p>因此，我们使用 INT UNSIGNED（占用 4 个字节）存储 IP，非 Char(15)。占 15 个字节。</p> <p>下图所示，IP：192.168.0.1 与整数之间的转换。</p> <p><img src="/mysql/03_ip.png" alt=""></p> <p>将 IP 的存储从字符型转换成整形，转化后数字是连续的，提高了查询性能，使查询更快，占用空间更小。</p> <p><strong>TIMESTAMP 处理</strong></p> <p>同样的方法，我们使用 MySQL 内置的函数(FROM_UNIXTIME()，UNIX_TIMESTAMP())，可以将日期转化为数字，用 INT UNSIGNED 存储日期和时间。</p> <p>下图示所示，时间 2007-11-30 10:30:19 与整数之间的转换，转化后数字是连续的，占用空间更小，并且可以使用索引提升查询性能。</p> <p><img src="/mysql/03_timestamp.png" alt=""></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/4/2020, 9:42:34 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bb7afb86.js" defer></script><script src="/assets/js/2.762c3895.js" defer></script><script src="/assets/js/3.116fffb6.js" defer></script><script src="/assets/js/29.474ecc3a.js" defer></script>
  </body>
</html>
