---
title: 第03讲：高性能数据库表该如何设计
---
## 使用原则

MySQL 虽然具有很多特性并提供了很多功能，但是有些特性会严重影响它的性能，比如，在数据库里进行计算，写大事务、大 SQL、存储大字段等。

想要发挥 MySQL 的最佳性能，需要遵循 3 个基本使用原则。

1. 首先是需要让 MySQL 回归存储的基本职能：MySQL 数据库只用于数据的存储，不进行数据的复杂计算，不承载业务逻辑，确保存储和计算分离；

2. 其次是查询数据时，尽量单表查询，减少跨库查询和多表关联；

3. 还有就是要杜绝大事务、大 SQL、大批量、大字段等一系列性能杀手。

* 大事务，运行步骤较多，涉及的表和字段较多，容易造成资源的争抢，甚至形成死锁。一旦事务回滚，会导致资源占用时间过长。

* 大 SQL，复杂的 SQL 意味着过多的表的关联，MySQL 数据库处理关联超过 3 张表以上的 SQL 时，占用资源多，性能低下。

* 大批量，意味着多条 SQL 一次性执行完成，必须确保进行充分的测试，并且在业务低峰时段或者非业务时段执行。

* 大字段，blob、text 等大字段，尽量少用。必须要用时，尽量与主业务表分离，减少对这类字段的检索和更新。

## 基本设置规则

1. 必须指定默认存储引擎为 InnoDB，并且禁用 MyISAM 存储引擎，随着 MySQL 8.0 版本的发布，所有的数据字典表都已经转换成了 InnoDB，MyISAM 存储引擎已成为了历史。

2. 默认字符集 UTF8mb4，以前版本的 UTF8 是 UTF8mb3，未包含个别特殊字符，新版本的 UTF8mb4 包含所有字符，官方强烈建议使用此字符集。

3. 关闭区分大小写功能。设置 lower_case_tables_name=1，即可关闭区分大小写功能，即大写字母 T 和小写字母 t 一样。

MySQL 数据库提供的功能很全面，但并不是所有的功能性能都高效。

1. 存储过程、触发器、视图、event。为了存储计算分离，这类功能尽量在程序中实现。这些功能非常不完整，调试、排错、监控都非常困难，相关数据字典也不完善，存在潜在的风险。一般在生产数据库中，禁止使用。

2. lob、text、enum、set。这些字段类型，在 MySQL 数据库的检索性能不高，很难使用索引进行优化。如果必须使用这些功能，一般采取特殊的结构设计，或者与程序结合使用其他的字段类型替代。比如：set 可以使用整型（0，1，2，3）、注释功能和程序的检查功能集合替代。

## 规范命名

库名的命名规范如下，命名时的字符取值范围为：a~z，0~9 和 _（下画线）。 

1. 所有表名小写，不允许驼峰式命名；

2. 允许使用 -（横线）和 （空格）；如下图所示，当使用 -（横线），后台默认会转化成 @002d；

3. 不允许使用其他特殊字符作为名称，减少潜在风险。

数据库库名的命名规则必须遵循“见名知意”的原则，即库名规则为“数据库类型代码 + 项目简称 + 识别代码 + 序号”。

这样包含了更多的业务信息，比如：

* 出入系统业务生产库：AOCT、AOCT1、AOCT2；

* 出入系统业务开发库：AOCTDEV、AOCTDEV1、AOCTDEV2；

* 出入系统业务测试库：AOCTTEST、AOCTTEST1、AOCTTEST2；

* 只有一个数据库，则不加序号，否则末尾增加序号；

* 生产库不加识别代码，否则需要增加识别代码 DEV 或 TEST；

* 如果只作历史库，则只需要项目简称 +H+ 序号；

表名的命名规则分为：

1. 单表仅使用 a~z、_；

2. 分表名称为“表名_编号”；

3. 业务表名代表用途、内容：子系统简称_业务含义_后缀。

常见业务表类型有：

* 临时表，tmp；

* 备份表，bak；

* 字典表，dic；

* 日志表，log。

字段名精确，遵循“见名知意”的原则，格式：名称_后缀。

* 避免普遍简单、有歧义的名称。

用户表中，用户名的字段为 UserName 比 Name 更好。

* 布尔型的字段，以助动词（has/is）开头。

用户是否有留言 hasmessage，用户是否通过检查 ischecked 等。

常见后缀如下：

* 流水号/无意义主键，后缀为 id，比如 task_id；

* 时间，后缀为 time，insert_time。

程序账号与数据库名称保持一致。如果所有的程序账号都是 root@‘%’，密码也一样，很容易错连到其他的数据库，造成误操作。

索引命名格式，主要为了区分哪些对象是索引：

* 前缀_表名（或缩写）_字段名（或缩写）；

* 主键必须使用前缀“pk_”；

* UNIQUE 约束必须使用前缀“uk_”；

* 普通索引必须使用前缀“idx_”。

数据库规范库表字段的命名，能够提高数据库的易读性，为数据库表设计打下基础。下面我们具体看看表设计的一些规则。

* 显式指定需要的属性；

创建表时显示指定字符集、存储引擎、注释信息等。         

* 不同系统之间，统一规范；

不同表之间的相同字段或者关联字段，字段类型/命名要保持一致；库表字符集和前端程序、中间件必须保持一致的 UTF8mb4。

### InnoDB 表的注意事项

1. 主键列，UNSIGNED 整数，使用 auto_increment；禁止手动更新 auto_increment，可以删除。

2. 必须添加 comment 注释。

3. 必须显示指定的 engine。

4. 表必备三字段：id、 xxx_create、 xxx_modified。

* id 为主键，类型为 unsigned bigint 等数字类型；

* xxx_create、xxx_modified 的类型均为 datetime 类型，分别记录该条数据的创建时间、修改时间。

### 备份表/临时表等常见表的设计规范

备份表/临时表等常见表的设计规范如下。

1. 备份表，表名必须添加 bak 和日期，主要用于系统版本上线时，存储原始数据，上线完成后，必须及时删除。

2. 临时表，用于存储中间业务数据，定期优化，及时降低表碎片。

3. 日志类表，首先考虑不入库，保存成文件，其次如果入库，明确其生命周期，保留业务需求的数据，定期清理。

4. 大字段表，把主键字段和大字段，单独拆分成表，并且保持与主表主键同步，尽量减少大字段的检索和更新。

5. 大表，根据业务需求，从垂直和水平两个维度进行拆分。

垂直拆分：按列关联度。

水平拆分：

* 按照时间、地域、范围等；

* 冷热数据（历史数据归档）。

字段设计要求

1. 根据业务场景需求，选择合适的类型，最短的长度；确保字段的宽度足够用，但也不要过宽。所有字段必须为 NOT NULL，空值则指定 default 值，空值难以优化，查询效率低。比如：人的年龄用 unsigned tinyint（范围 0~255，人的寿命不会超过 255 岁）；海龟就必须是 smallint，但如果是太阳的年龄，就必须是 int；如果是所有恒星的年龄都加起来，那么就必须使用 bigint。

2. 表字段数少而精，尽量不加冗余列。

3. 单实例表个数必须控制在 2000 个以内。

4. 单表分表个数必须控制在 1024 个以内。

5. 单表字段数上限控制在 20~50 个。

禁用 ENUM、SET 类型。

* 兼容性不好，性能差。

解决方案：使用 TINYINT，在 COMMENT 信息中标明被枚举的含义。`is_disable` TINYINT UNSIGNED DEFAULT '0' COMMENT '0:启用 1:禁用 2:异常’。

禁用列为 NULL。

* MySQL 难以优化 NULL 列；

* NULL 列加索引，需要额外空间；

* 含 NULL 复合索引无效。

解决方案：在列上添加 NOT NULL DEFAULT 缺省值。

禁止 VARBINARY、BLOB 存储图片、文件等。

* 禁止在数据库中存储大文件，例如照片，可以将大文件存储在对象存储系统中，数据库中存储路径。

不建议使用 TEXT/BLOB：

* 处理性能差；

* 行长度变长；

* 全表扫描代价大。

解决方案：拆分成单独的表。

存储字节越小，占用空间越小。尽量选择合适的整型，如下图所示。

![](/mysql/03_int.png)

1. 主键列，无负数，建议使用 INT UNSIGNED 或者 BIGINT UNSIGNED；预估字段数字取值会超过 42 亿，使用 BIGINT 类型。

2. 短数据使用 TINYINT 或 SMALLINT，比如：人类年龄，城市代码。

3. 使用 UNSIGNED 存储非负数值，扩大正数的范围。

**int(3)/int(5) 区别**

int(3)/int(5) 的区别，如下图所示。

![](/mysql/03_int3_5.png)

* 正常显示没有区别。

* 3 和 5 仅是最小显示宽度而已。

* 有 zerofill 等扩展属性时则显示有区别。

**浮点数与定点数区别**

浮点数与定点数区别，如下图所示。

![](/mysql/03_float_decimal.png)

1. 浮点数：float、double（或 real）。

2. 定点数：decimal（或 numberic）。

从上图中可以观察到：

* 浮点数存在误差问题；

* 尽量避免进行浮点数比较；

* 对货币等对精度敏感的数据，应该使用定点数。

## 案例

**IP 处理**

一般使用 Char(15) 进行存储，但是当进行查找和统计时，字符类型不是很高效。

MySQL 数据库内置了两个 IP 相关的函数 INET_ATON()、INET_NTOA()，可以实现 IP 地址和整数的项目转换。

因此，我们使用 INT UNSIGNED（占用 4 个字节）存储 IP，非 Char(15)。占 15 个字节。

下图所示，IP：192.168.0.1 与整数之间的转换。

![](/mysql/03_ip.png)

将 IP 的存储从字符型转换成整形，转化后数字是连续的，提高了查询性能，使查询更快，占用空间更小。

**TIMESTAMP 处理**

同样的方法，我们使用 MySQL 内置的函数(FROM_UNIXTIME()，UNIX_TIMESTAMP())，可以将日期转化为数字，用 INT UNSIGNED 存储日期和时间。

下图示所示，时间 2007-11-30 10:30:19 与整数之间的转换，转化后数字是连续的，占用空间更小，并且可以使用索引提升查询性能。

![](/mysql/03_timestamp.png)
